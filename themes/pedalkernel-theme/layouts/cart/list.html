{{ define "main" }}
<div class="container">
  <h1>Shopping Cart</h1>

  <div id="cart-root" class="cart">
    <div class="cart-items" data-cart-mount></div>

    <div class="cart-summary">
      <p class="cart-summary__subtotal"><strong>Subtotal:</strong> <span data-cart-total>$0.00</span></p>
      <p class="muted">Digital products — no shipping required.</p>
      <a class="buy-button" href="/checkout/" id="goto-checkout" style="width: 100%; margin-bottom: 0.5rem;">Checkout</a>
      <a href="/products/" class="btn btn-secondary">← Continue Shopping</a>
    </div>
  </div>
</div>

<script>
(function(){
  const money = (cents) => "$" + (Number(cents||0)/100).toFixed(2);

  function render(state){
    const mount = document.querySelector("[data-cart-mount]");
    if (!mount) return;
    const items = state.items || [];

    if (!items.length) {
      document.getElementById("goto-checkout").style.display = "none";
      mount.innerHTML = `
        <div class="cart-empty">
          <p>Your cart is empty.</p>
          <p><a href="/products/" class="btn">Browse Products</a></p>
        </div>
      `;
      return;
    }
    document.getElementById("goto-checkout").style.display = "inline-block";

    let html = '<div class="cart-items-list">';
    let totalCents = 0;

    items.forEach(i => {
      const itemTotal = (i.price_cents || 0) * (i.qty || 1);
      totalCents += itemTotal;

      html += `
        <div class="cart-row" data-sku="${i.sku}">
          ${i.image ? `<img class="cart-thumb" src="${i.image}" alt="">` : ""}
          <div class="cart-meta">
            <div class="cart-title">${i.title} <span class="muted">(${i.sku})</span></div>
            <div class="cart-price">${money(i.price_cents)}</div>
          </div>
          <div class="cart-qty">
            <div class="qty-control">
              <button type="button" class="qty-btn" data-qty-change="-1" data-sku="${i.sku}">−</button>
              <span class="qty-value">${i.qty}</span>
              <button type="button" class="qty-btn" data-qty-change="1" data-sku="${i.sku}">+</button>
            </div>
            <a href="#" data-cart-remove data-sku="${i.sku}" class="remove-link">Remove</a>
          </div>
        </div>
      `;
    });

    html += '</div>';
    mount.innerHTML = html;

    const totalEl = document.querySelector("[data-cart-total]");
    if (totalEl) totalEl.textContent = money(totalCents);

    mount.querySelectorAll("[data-qty-change]").forEach(btn => {
      btn.addEventListener("click", function(e) {
        e.preventDefault();
        if (!window.GSGCart) return;
        const sku = this.dataset.sku;
        const change = parseInt(this.dataset.qtyChange, 10);
        const currentQty = window.GSGCart.get().items.find(i => i.sku === sku)?.qty || 0;
        const newQty = Math.max(0, currentQty + change);
        
        if (newQty === 0) {
          window.GSGCart.remove(sku);
        } else {
          window.GSGCart.setQty(sku, newQty);
        }
      });
    });

    mount.querySelectorAll("[data-cart-remove]").forEach(link => {
      link.addEventListener("click", function(e) {
        e.preventDefault();
        if (!window.GSGCart) return;
        window.GSGCart.remove(this.dataset.sku);
      });
    });
  }

  function repaint(){ render(window.GSGCart.get()); }

  document.addEventListener("cart:updated", repaint);
  document.addEventListener("DOMContentLoaded", () => {
    if (window.GSGCart) {
      window.GSGCart.checkoutClean();
      repaint();
    }
  });
})();
</script>
{{ end }}